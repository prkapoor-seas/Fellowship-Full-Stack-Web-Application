<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
  </head>
  <body>
    <header class="topbar">
      <div class="inner_topbar">
        <div class="logo">
          <a class="logotext" href="{{ url_for('index') }}">LabsAtYale</a>
        </div>
        <nav class="navigationBar">
          <a
            href="{{ url_for('fellowships') }}"
            class="{% if request.path == '/fellowships' %}active{% endif %}"
            >Fellowships</a
          >
          <a
            href="{{ url_for('labs') }}"
            class="{% if request.path == '/labs' %}active{% endif %}"
            >Labs</a
          >
          <a
            href="{{ url_for('faculty') }}"
            class="{% if request.path == '/faculty' %}active{% endif %}"
            >Faculty</a
          >

          {% if current_user.role == 'faculty' %}
          <a href="{{ url_for('add_fellowship') }}">Add a Fellowship</a>
          <a
            href="{{ url_for('faculty_fellowships') }}"
            class="{% if request.path == '/faculty/fellowships' %}active{% endif %}"
            >Ranking</a
          >
          <a
            href="{{ url_for('faculty_all_applicants') }}"
            class="{% if request.path == '/faculty/applicants' %}active{% endif %}"
            >Applicants</a
          >
          <!--          {% if fellowship_id %}<a-->
          <!--            href="{{ url_for('faculty_fellowship_applicants', fellowship_id=fellowship_id) }}"-->
          <!--            class="{% if request.path == '/faculty/fellowship' %}active{% endif %}"-->
          <!--            >Applicants</a-->
          <!--          >{% endif %} -->
          {% endif %} {% if current_user.is_authenticated %}
          <a
            href="{{ url_for('profile') }}"
            class="{% if request.path == '/profile' %}active{% endif %}"
            >Profile</a
          >
          <a href="{{ url_for('logout') }}">Logout</a>
          {% else %}
          <a href="{{ url_for('login') }}">Login</a>
          {% endif %}
        </nav>
      </div>
    </header>

    <main style="max-width: 1200px; margin: 0 auto; padding: 20px">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        style="padding: 15px; margin-bottom: 20px; border-radius: 4px; {% if category == 'success' %}background: #d4edda; color: #155724; border: 1px solid #c3e6cb;{% elif category == 'danger' %}background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;{% elif category == 'warning' %}background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;{% else %}background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;{% endif %}"
      >
        {{ message }}
      </div>
      {% endfor %} {% endif %} {% endwith %} {% if fellowship_data|length == 0
      %}
      <p>No fellowships found.</p>
      {% else %} {% for item in fellowship_data %} {% set fellowship =
      item.fellowship %} {% set applicants = item.applicants %} {% set
      matched_students = item.matched_students %}

      <section
        style="
          margin-bottom: 50px;
          padding: 20px;
          border-radius: 5px;
          border: 1px solid #ddd;
        "
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2 style="margin: 0">{{ fellowship.get_fellowship_name() }}</h2>
          <form
            method="POST"
            action="{{ url_for('delete_fellowship_route', fellowship_id=fellowship.get_fellowship_id()) }}"
            style="display: inline"
          >
            <button
              type="submit"
              class="btn-danger"
              onclick="return confirm('Are you sure you want to remove this fellowship? This action cannot be undone.');"
            >
              Remove Fellowship
            </button>
          </form>
        </div>
        {% if applicants|length == 0 %}
        <p>No applications yet for this fellowship.</p>
        {% else %}

        <div
          style="
            margin-bottom: 40px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
          "
        >
          <h3>Rank Applicants</h3>
          <p>
            Drag and drop to rank applicants in order of preference. #1 is your
            top choice.
          </p>

          <form
            method="POST"
            action="{{ url_for('faculty_fellowships') }}"
            id="rankForm{{ fellowship.get_fellowship_id() }}"
            onsubmit="return beforeSubmit(this);"
          >
            <input type="hidden" name="action" value="rank" />
            <input
              type="hidden"
              name="fellowship_id"
              value="{{ fellowship.get_fellowship_id() }}"
            />
            <div
              class="applicantsContainer"
              style="
                border: 1px solid #ddd;
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 15px;
              "
            >
              {% for applicant in applicants %}
              <div
                class="applicant-item"
                draggable="true"
                style="
                  padding: 12px;
                  margin-bottom: 10px;
                  border: 1px solid #ccc;
                  border-radius: 4px;
                  cursor: move;
                "
                data-student-id="{{ applicant.student_net_id }}"
              >
                <strong
                  >{{ applicant.student_first_name }} {{
                  applicant.student_last_name }}</strong
                >
                <br /><small
                  >Net ID: {{ applicant.student_net_id }} | Major: {{
                  applicant.major }} | Class: {{ applicant.class_year }}</small
                >
                {% if applicant.questions %}
                <br /><small
                  style="display: block; margin-top: 5px; color: #666"
                  >Statement: {{ applicant.questions[:100] }}...</small
                >
                {% endif %}
              </div>
              {% endfor %}
            </div>

            <button
              type="submit"
              class="btn btn-primary"
              style="
                background: #007bff;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                margin-right: 10px;
              "
            >
              Save Rankings
            </button>
          </form>

          <script>
              let draggedElement{{ fellowship.get_fellowship_id() }} = null;

              function initializeDragDrop{{ fellowship.get_fellowship_id() }}() {
                const form = document.getElementById('rankForm{{ fellowship.get_fellowship_id() }}');
                const container = form.querySelector('.applicantsContainer');

                container.querySelectorAll('.applicant-item').forEach(item => {
                  item.addEventListener('dragstart', (e) => {
                    draggedElement{{ fellowship.get_fellowship_id() }} = item;
                    item.style.opacity = '0.5';
                  });

                  item.addEventListener('dragend', (e) => {
                    item.style.opacity = '1';
                  });

                  item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                  });

                  item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement{{ fellowship.get_fellowship_id() }} !== item) {
                      const allItems = Array.from(container.querySelectorAll('.applicant-item'));
                      const draggedIndex = allItems.indexOf(draggedElement{{ fellowship.get_fellowship_id() }});
                      const targetIndex = allItems.indexOf(item);

                      if (draggedIndex < targetIndex) {
                        item.parentNode.insertBefore(draggedElement{{ fellowship.get_fellowship_id() }}, item.nextSibling);
                      } else {
                        item.parentNode.insertBefore(draggedElement{{ fellowship.get_fellowship_id() }}, item);
                      }
                    }
                  });
                });
              }

            function beforeSubmit(form) {

                const container = form.querySelector('.applicantsContainer');
                const items = container.querySelectorAll('.applicant-item');


                form.querySelectorAll('input[name="applicant_rank[]"]').forEach(i => i.remove());


                items.forEach((item) => {
                    const studentId = item.getAttribute('data-student-id');
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'applicant_rank[]';
                    input.value = studentId;
                    form.appendChild(input);
                });

                return true;
            }


              document.addEventListener('DOMContentLoaded', initializeDragDrop{{ fellowship.get_fellowship_id() }});
          </script>

          <style>
            .applicant-item:hover {
              background: #f0f0f0;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
          </style>
        </div>

        <div
          style="
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
          "
        >
          <h3>Matching</h3>
          <form
            method="POST"
            action="{{ url_for('faculty_fellowships') }}"
            style="margin-bottom: 20px"
          >
            <input type="hidden" name="action" value="match" />
            <button
              type="submit"
              class="btn btn-success"
              style="
                background: #28a745;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              Match Now
            </button>
          </form>

          {% if matched_students %}
          <div
            style="
              padding: 15px;
              background: white;
              border-left: 4px solid #ccc;
              border-radius: 4px;
              margin-top: 15px;
            "
          >
            <h4 style="margin-top: 0; color: #000000">Matched Students</h4>
            <ul style="list-style: none; padding: 0; margin: 0">
              {% for student_net_id in matched_students %}
              <li style="padding: 8px 0; border-bottom: 1px solid #ddd">
                {{ student_net_id }}
              </li>
              {% endfor %}
            </ul>
          </div>
          {% else %}
          <p
            style="
              padding: 15px;
              background: #fff3cd;
              border-left: 4px solid #ffc107;
              border-radius: 4px;
              color: #856404;
              margin-top: 15px;
            "
          >
            <em
              >No matches yet. Make sure applicants have rankings saved, then
              click "Match Now" to run the matching algorithm.</em
            >
          </p>
          {% endif %}
        </div>
        {% endif %}
      </section>
      {% endfor %} {% endif %}
    </main>
  </body>
</html>
